{% extends 'base.html' %}

{% block title %}PRE-PROCESS - BBLIZE{% endblock %}

{% block content %}
<style>
    .upload-section {
        background-color: white;
        padding: 40px;
        border-radius: 5px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        margin-bottom: 30px;
    }
    
    .upload-box:hover {
        background-color: #fff5f5;
        border-color: #c0392b;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .upload-box input[type="file"] {
        display: none;
    }

    .upload-box p {
        font-size: 14px;
        color: #999;
        margin: 0;
        word-wrap: break-word; 
        overflow-wrap: break-word;
    }
    
    .file-info {
        background-color: #e8f5e9;
        padding: 12px 20px;
        border-radius: 5px;
        margin: 15px auto 20px;
        display: none;
        max-width: 600px;
        border-left: 4px solid #4CAF50;
    }
    
    .file-info.show {
        display: block;
    }
    
    .preview-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
        background-color: white;
    }
    
    .preview-table th {
        background-color: #333;
        color: white;
        padding: 12px;
        text-align: left;
        font-weight: 600;
    }
    
    .preview-table td {
        padding: 10px 12px;
        border-bottom: 1px solid #ddd;
    }
    
    .preview-table tr:hover {
        background-color: #f5f5f5;
    }
    
    .action-buttons {
        display: flex;
        gap: 15px;
        margin-top: 20px;
        justify-content: center;
        flex-wrap: wrap;
    }
    
    .progress-bar {
        width: 100%;
        height: 30px;
        background-color: #f0f0f0;
        border-radius: 5px;
        overflow: hidden;
        margin-top: 20px;
        display: none;
    }
    
    .progress-bar.show {
        display: block;
    }
    
    .progress-fill {
        height: 100%;
        background-color: #e74c3c;
        width: 0%;
        transition: width 0.3s;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
    }
    
    .result-section {
        background-color: white;
        padding: 40px;
        border-radius: 5px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        margin-top: 30px;
        display: none;
    }
    
    .result-section.show {
        display: block;
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin: 20px 0;
    }
    
    .stat-box {
        background-color: #f9f9f9;
        padding: 20px;
        border-radius: 5px;
        text-align: center;
        border-left: 4px solid #e74c3c;
    }
    
    .stat-number {
        font-size: 32px;
        font-weight: 700;
        color: #e74c3c;
        margin-bottom: 5px;
    }
    
    .stat-label {
        color: #666;
        font-size: 14px;
    }
    
    .alert {
        padding: 15px;
        border-radius: 5px;
        margin-bottom: 20px;
    }
    
    .alert-info {
        background-color: #f1bac5;
        border-left: 4px solid #dca1e7;
        color: #000000;
    }
    
    .alert-success {
        background-color: #e8f5e9;
        border-left: 4px solid #4CAF50;
        color: #2E7D32;
    }
    
    .scrollable-table {
        max-height: 600px;
        overflow-y: auto;
        border: 1px solid #ddd;
        border-radius: 5px;
    }
    
    .processing-steps {
        background-color: #f9f9f9;
        padding: 20px 30px;
        border-radius: 8px;
        margin-top: 30px;
        max-width: 800px;
        margin-left: auto;
        margin-right: auto;
    }
    
    .processing-steps h4 {
        margin-bottom: 15px;
        color: #333;
    }
    
    .processing-steps ol {
        margin-left: 20px;
    }
    
    .processing-steps li {
        margin-bottom: 8px;
        color: #666;
    }

    /* ===== PAGINATION STYLES ===== */
    .pagination-container {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        margin-top: 25px;
        flex-wrap: wrap;
    }

    .pagination-button {
        padding: 8px 12px;
        border: 1px solid #ddd;
        background-color: white;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.2s;
    }

    .pagination-button:hover:not(:disabled) {
        background-color: #e74c3c;
        color: white;
        border-color: #e74c3c;
    }

    .pagination-button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .pagination-button.active {
        background-color: #e74c3c;
        color: white;
        border-color: #e74c3c;
        font-weight: 600;
    }

    .pagination-info {
        font-size: 14px;
        color: #666;
        min-width: 150px;
        text-align: center;
    }
</style>

<div class="content">
    <h1>DATA PRE-PROCESSING</h1>
    
    <div class="alert alert-info">
        <strong>Format Data yang Diperlukan:</strong><br>
        ‚Ä¢ File CSV atau XLSX dengan kolom Review (teks review) dan Rating (angka 1-5)<br>
        ‚Ä¢ Pastikan tidak ada kolom kosong<br>
    </div>
    
    <div class="upload-section">
        <h3>Upload Dataset Mentah Review</h3>
        <h4>Klik untuk memilih file</h4>
        <p>Mendukung format CSV dan XLSX (Max 50MB)</p>
        <input type="file" id="fileInput" name="file" accept=".csv,.xlsx">

        <div class="file-info" id="fileInfo">
            <strong>File terpilih:</strong> <span id="fileName"></span><br>
            <strong>Ukuran:</strong> <span id="fileSize"></span>
        </div>
        
        <div class="processing-steps">
            <h4>Tahapan Pre-processing:</h4>
            <ol>
                <li><strong>Sentence Splitting</strong> - Memisahkan review menjadi kalimat-kalimat</li>
                <li><strong>Cleaning</strong> - Menghapus URL, hashtag, angka, dan karakter khusus</li>
                <li><strong>Remove Emoji</strong> - Menghapus emoji dan simbol non-ASCII</li>
                <li><strong>Normalize Characters</strong> - Mengurangi karakter berulang</li>
                <li><strong>Case Folding</strong> - Mengubah semua teks menjadi huruf kecil</li>
                <li><strong>Tokenization</strong> - Memecah kalimat menjadi token/kata</li>
                <li><strong>Slang Normalization</strong> - Mengubah kata slang menjadi kata baku</li>
                <li><strong>Stemming</strong> - Mengubah kata ke bentuk dasar (Sastrawi)</li>
                <li><strong>Stopword Removal</strong> - Menghapus kata-kata umum</li>
            </ol>
        </div>
    </div>
    
    <div class="upload-section" id="previewSection" style="display: none;">
        <h3>Preview Data</h3>
        <div id="previewContent"></div>
        
        <div class="action-buttons">
            <button class="btn btn-primary" id="processBtn">Mulai Pre-Processing</button>
        </div>
        
        <div class="progress-bar" id="progressBar">
            <div class="progress-fill" id="progressFill">0%</div>
        </div>
    </div>
    
    <div class="result-section" id="resultSection">
        <div class="alert alert-success">
            <strong>Pre-processing berhasil!</strong> Data Anda telah dibersihkan dan siap digunakan.
        </div>
        
        <div class="stats-grid" id="statsGrid"></div>
        
        <h3>Preview Data Bersih</h3>
        <div class="scrollable-table" id="resultPreview"></div>

        <!-- PAGINATION CONTROLS -->
        <div class="pagination-container">
            <button class="pagination-button" id="prevBtn" onclick="previousPage()">‚Üê Sebelumnya</button>
            
            <div class="pagination-info">
                <span id="pageInfo">Halaman 1 dari 1</span>
            </div>
            
            <button class="pagination-button" id="nextBtn" onclick="nextPage()">Selanjutnya ‚Üí</button>
        </div>
        
        <div class="action-buttons">
            <button class="btn btn-primary" id="downloadBtn">Download Full Data (.csv)</button>
        </div>
    </div>
</div>

<script>
    const fileInput = document.getElementById('fileInput');
    const fileInfo = document.getElementById('fileInfo');
    const fileName = document.getElementById('fileName');
    const fileSize = document.getElementById('fileSize');
    const previewSection = document.getElementById('previewSection');
    const previewContent = document.getElementById('previewContent');
    const processBtn = document.getElementById('processBtn');
    const progressBar = document.getElementById('progressBar');
    const progressFill = document.getElementById('progressFill');
    const resultSection = document.getElementById('resultSection');
    const statsGrid = document.getElementById('statsGrid');
    const resultPreview = document.getElementById('resultPreview');
    const downloadBtn = document.getElementById('downloadBtn');
    
    // Pagination variables
    let allData = [];
    let currentPage = 1;
    const ROWS_PER_PAGE = 15;
    
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    const csrftoken = getCookie('csrftoken');
    
    fileInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            fileName.textContent = file.name;
            fileSize.textContent = formatFileSize(file.size);
            fileInfo.classList.add('show');
            previewFile(file);
        }
    });
    
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
    }
    
    function previewFile(file) {
        const formData = new FormData();
        formData.append('file', file);
        formData.append('action', 'preview');
        
        fetch('/preprocess/', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': csrftoken
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayPreview(data);
                previewSection.style.display = 'block';
                previewSection.scrollIntoView({ behavior: 'smooth' });
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Terjadi kesalahan saat membaca file');
        });
    }
    
    function displayPreview(data) {
        let html = '<p><strong>üìä Total baris:</strong> ' + data.total_rows + '</p>';
        html += '<p><strong>üìã Kolom:</strong> ' + data.columns.join(', ') + '</p>';
        html += '<div class="scrollable-table"><table class="preview-table">';
        html += '<thead><tr>';
        
        data.columns.forEach(col => {
            html += '<th>' + col + '</th>';
        });
        html += '</tr></thead><tbody>';
        
        data.preview.forEach(row => {
            html += '<tr>';
            data.columns.forEach(col => {
                let cellValue = row[col] || '';
                if (typeof cellValue === 'string' && cellValue.length > 100) {
                    cellValue = cellValue.substring(0, 100) + '...';
                }
                html += '<td>' + cellValue + '</td>';
            });
            html += '</tr>';
        });
        
        html += '</tbody></table></div>';
        previewContent.innerHTML = html;
    }
    
    processBtn.addEventListener('click', function() {
        if (!fileInput.files[0]) {
            alert('Silakan upload file terlebih dahulu');
            return;
        }
        
        const formData = new FormData();
        formData.append('file', fileInput.files[0]);
        formData.append('action', 'process');
        
        progressBar.classList.add('show');
        processBtn.disabled = true;
        processBtn.textContent = '‚è≥ Memproses...';
        
        let progress = 0;
        const progressInterval = setInterval(() => {
            progress += 5;
            if (progress <= 90) {
                progressFill.style.width = progress + '%';
                progressFill.textContent = progress + '%';
            }
        }, 200);
        
        fetch('/preprocess/', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': csrftoken
            }
        })
        .then(response => response.json())
        .then(data => {
            clearInterval(progressInterval);
            progressFill.style.width = '100%';
            progressFill.textContent = '100%';
            
            if (data.success) {
                allData = data.preview; // Simpan SEMUA data
                currentPage = 1; // Reset ke halaman 1
                displayResult(data);
                displayPaginatedData();
                setTimeout(() => {
                    resultSection.classList.add('show');
                    resultSection.scrollIntoView({ behavior: 'smooth' });
                }, 500);
            } else {
                alert('Error: ' + data.error);
            }
            
            processBtn.disabled = false;
            processBtn.textContent = 'üöÄ Mulai Pre-Processing';
        })
        .catch(error => {
            clearInterval(progressInterval);
            console.error('Error:', error);
            alert('Terjadi kesalahan saat memproses data');
            processBtn.disabled = false;
            processBtn.textContent = 'üöÄ Mulai Pre-Processing';
        });
    });
    
    function displayResult(data) {
        statsGrid.innerHTML = `
            <div class="stat-box">
                <div class="stat-number">${data.stats.total_reviews}</div>
                <div class="stat-label">Total Review</div>
            </div>
            <div class="stat-box">
                <div class="stat-number">${data.stats.total_sentences}</div>
                <div class="stat-label">Total Kalimat</div>
            </div>
            <div class="stat-box">
                <div class="stat-number">${data.stats.avg_sentences}</div>
                <div class="stat-label">Rata-rata Kalimat/Review</div>
            </div>
        `;
    }
    
    function displayPaginatedData() {
        const totalPages = Math.ceil(allData.length / ROWS_PER_PAGE);
        const start = (currentPage - 1) * ROWS_PER_PAGE;
        const end = start + ROWS_PER_PAGE;
        const pageData = allData.slice(start, end);
        
        let html = '<table class="preview-table"><thead><tr>';
        html += '<th>Review ID</th><th>Rating</th><th>Kalimat</th><th>Tokens</th>';
        html += '</tr></thead><tbody>';
        
        pageData.forEach(row => {
            html += '<tr>';
            html += '<td>' + row.review_id + '</td>';
            html += '<td>' + row.rating + '</td>';
            html += '<td style="max-width: 300px; word-wrap: break-word;">' + (row.sentence.length > 100 ? row.sentence.substring(0, 100) + '...' : row.sentence) + '</td>';
            html += '<td style="max-width: 300px; word-wrap: break-word;">' + (row.tokens_str.length > 100 ? row.tokens_str.substring(0, 100) + '...' : row.tokens_str) + '</td>';
            html += '</tr>';
        });
        
        html += '</tbody></table>';
        resultPreview.innerHTML = html;
        
        // Update pagination info
        document.getElementById('pageInfo').textContent = `Halaman ${currentPage} dari ${totalPages} (${allData.length} total baris)`;
        
        // Update button states
        document.getElementById('prevBtn').disabled = currentPage === 1;
        document.getElementById('nextBtn').disabled = currentPage === totalPages;
    }
    
    function nextPage() {
        const totalPages = Math.ceil(allData.length / ROWS_PER_PAGE);
        if (currentPage < totalPages) {
            currentPage++;
            displayPaginatedData();
            resultPreview.scrollIntoView({ behavior: 'smooth' });
        }
    }
    
    function previousPage() {
        if (currentPage > 1) {
            currentPage--;
            displayPaginatedData();
            resultPreview.scrollIntoView({ behavior: 'smooth' });
        }
    }
    
    downloadBtn.addEventListener('click', function() {
        if (allData.length > 0) {
            window.location.href = '/preprocess/?download=full';
        }
    });
</script>
{% endblock %}